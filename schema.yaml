title: "OCI HPC BM Cluster Stack"
description: "Provision a head node and 4 BM.Optimized3.36 nodes on OCI."
informationalText: "Provide one RHEL 8.8 image OCID for BM nodes; the same image is used for the head node. Tenancy and region are pre-filled from your session."
schemaVersion: 1.1.0
version: "20190304"
locale: "en"

variableGroups:
  - title: "Target Configuration"
    variables:
      - compartment_ocid
      - ssh_public_key
      - bm_node_image_ocid

  - title: "Networking"
    variables:
      - use_existing_vcn
      - existing_vcn_id
      - existing_public_subnet_id
      - existing_private_subnet_id

  - title: "Stack context (pre-filled from your session)"
    variables:
      - tenancy_ocid
      - region

variables:
  tenancy_ocid:
    type: string
    title: "Tenancy OCID"
    description: "Pre-filled from your session. Change only if deploying to a different tenancy."
    required: true

  region:
    type: oci:identity:region:name
    title: "Region"
    description: "Pre-filled from your session. Change only if deploying to a different region."
    required: true

  compartment_ocid:
    type: oci:identity:compartment:id
    title: "Compartment"
    description: "Compartment where resources are created."
    required: true
    dependsOn:
      compartmentId: ${tenancy_ocid}

  ssh_public_key:
    type: oci:core:ssh:publickey
    title: "SSH Public Key"
    description: "Public key injected into all instances."
    required: true

  bm_node_image_ocid:
    type: oci:core:image:id
    title: "RHEL 8.8 Image"
    description: "RHEL 8.8 image for BM nodes. Also used for the head node."
    required: true
    dependsOn:
      compartmentId: ${compartment_ocid}

  use_existing_vcn:
    type: boolean
    title: "Use Existing VCN"
    description: "If true, provide existing VCN and subnet OCIDs below."
    default: false
    required: true

  existing_vcn_id:
    type: oci:core:vcn:id
    title: "Existing VCN"
    description: "Required when Use Existing VCN is true."
    required: false
    dependsOn:
      compartmentId: ${compartment_ocid}

  existing_public_subnet_id:
    type: oci:core:subnet:id
    title: "Existing Public Subnet"
    description: "Public subnet for the head node when using existing VCN."
    required: false
    dependsOn:
      compartmentId: ${compartment_ocid}
      vcnId: ${existing_vcn_id}

  existing_private_subnet_id:
    type: oci:core:subnet:id
    title: "Existing Private Subnet"
    description: "Private subnet for BM nodes when using existing VCN."
    required: false
    dependsOn:
      compartmentId: ${compartment_ocid}
      vcnId: ${existing_vcn_id}

outputs:
  created_vcn_id:
    title: "Created/Selected VCN OCID"
    visible: true
  head_node_public_ip:
    title: "Head Node Public IP"
    visible: true
  bm_node_private_ips:
    title: "BM Node Private IPs"
    visible: true
